<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Integration Tests</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: #0a0a0f;
            color: white;
            font-family: sans-serif;
        }

        #canvas {
            border: 1px solid #333;
            background: #111;
            width: 100%;
            height: 100vh;
            display: block;
        }

        .controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
        }

        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px;
            cursor: pointer;
        }

        #status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: yellow;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div id="status">Initializing...</div>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <h3>Tests</h3>
        <button onclick="runTest('simple')">Simple Pulley</button>
        <button onclick="runTest('double')">Double Pulley</button>
        <button onclick="runTest('hanging')">Hanging Weight</button>
        <button onclick="clearScene()">Clear Scene</button>
        <button onclick="location.href='index.html'">Back</button>
    </div>

    <!-- Load Matter.js locally -->
    <script src="matter.min.js"></script>
    <!-- Load Config -->
    <script src="config.js"></script>
    <!-- Load App Logic -->
    <script src="app.js"></script>

    <script>
        const status = document.getElementById('status');

        window.onerror = function (msg, url, line) {
            status.style.color = 'red';
            status.innerText = `Error: ${msg} at line ${line}`;
            console.error(msg);
        };

        document.addEventListener('DOMContentLoaded', () => {
            status.innerText = 'DOM Loaded. Checking dependencies...';

            if (typeof Matter === 'undefined') {
                throw new Error('Matter.js not loaded');
            }
            if (typeof ObjectConfig === 'undefined') {
                throw new Error('config.js not loaded');
            }
            if (typeof App === 'undefined') {
                throw new Error('app.js not loaded');
            }

            status.innerText = 'Dependencies OK. Initializing App...';
            status.style.color = 'lime';

            // Force init if needed
            if (!App.engine) {
                console.log('Forcing init...');
                if (typeof init === 'function') init();
            }

            setTimeout(() => {
                status.innerText = 'Ready. Click a test.';
            }, 1000);
        });

        function clearScene() {
            if (App.engine) {
                Matter.Composite.clear(App.engine.world);
                App.objects = [];
                createGround(); // Ensure createGround is available globally or via App
            }
        }

        function runTest(type) {
            clearScene();
            const cfg = ObjectConfig;
            const world = App.engine.world;
            let objects = [];

            console.log(`Running test: ${type}`);

            if (type === 'simple') {
                const anchor = Matter.Bodies.rectangle(400, 100, cfg.anchor.width, cfg.anchor.height, { isStatic: true, render: { fillStyle: cfg.anchor.fillColor }, label: 'anchor' });
                const pulley = Matter.Bodies.circle(400, 250, cfg.pulley.radius, { isStatic: true, render: { fillStyle: cfg.pulley.fillColor }, label: 'pulley' });
                const weight = Matter.Bodies.rectangle(400, 450, cfg.weight.size, cfg.weight.size, { density: 0.1, render: { fillStyle: cfg.weight.fillColor }, label: 'weight' });
                objects = [anchor, pulley, weight];

                // Create ropes manually if createRope is not global
                // Assuming createRope is global from app.js
                setTimeout(() => {
                    createRope({ x: 400, y: 110, body: anchor }, { x: 400, y: 220, body: pulley });
                    createRope({ x: 400, y: 280, body: pulley }, { x: 400, y: 430, body: weight });
                }, 100);
            }
            else if (type === 'hanging') {
                const anchor = Matter.Bodies.rectangle(400, 100, cfg.anchor.width, cfg.anchor.height, { isStatic: true, render: { fillStyle: cfg.anchor.fillColor }, label: 'anchor' });
                const weight = Matter.Bodies.rectangle(400, 350, cfg.weight.size, cfg.weight.size, { density: 0.1, render: { fillStyle: cfg.weight.fillColor }, label: 'weight' });
                objects = [anchor, weight];
                setTimeout(() => {
                    createRope({ x: 400, y: 110, body: anchor }, { x: 400, y: 330, body: weight });
                }, 100);
            }

            Matter.Composite.add(world, objects);

            // Ensure runner is active
            if (!App.runner.enabled) {
                Matter.Runner.run(App.runner, App.engine);
            }
            App.isSimulating = true;
        }
    </script>
</body>

</html>